/*
 NicoJK
  TVTest ニコニコ実況プラグイン(再生＆投稿対応改造版) 修正18
*/

# 人柱注意！できるだけ同梱のバイナリではなく、開発環境を整えてざっとコードを眺め
# たうえで各自でビルドすることをお勧めします。
# このプラグインはニコニコ実況サーバ(jk.nicovideo.jp)と通信します。サーバに高負
# 荷を与えるような利用や改変をしないでください。

■なにこれ？
Rutice氏のNicoJKに、受信コメントのログファイルへの記録とファイル再生時のログ再生
機能をつけてみたものです。開発中であるTvtPlayJKとはたぶん方向性が違う(サーバから
過去ログをとってくるか録画中にログ記録するか、的な)ので、こういう手もあるかなと
いう参考例に利用ください。修正10からコメント投稿に対応しました。

■使い方
"NicoJK_src.zip"に同梱のNicoJK.tvtp(_x64はx64版TVTest用)を使う場合は「Visual C++
2010 SP1 再頒布可能パッケージ (x86/x64)」のインストールが必要です。
NicoJK.ini、NicoJK.tvtpをTVTestのPluginsフォルダに入れて、TVTestを起動して、プラ
グインを有効にしてください。

ログファイルへの記録機能は、NicoJK.iniのlogfileModeを1か2にして、Pluginsフォルダ
の中に"NicoJK"というフォルダを作っておくと有効になります。ログは"NicoJK"フォルダ
に保存されていきます。録画中に受信した実況コメントがファイル再生プラグイン(何で
もいい)で再生中に表示されればOKです。

些末なことですが勢い窓のフォントは「Meiryo UI」なので、XPやVista環境では入れてお
く(PowerPointViewerとかについてくる)とちょっとだけいい感じです。
Vista以降のAero環境で性能に余裕があればNicoJK.iniのtimerIntervalを-10000にすると
描画がスムーズになります。

■コメント投稿について
コメント投稿機能を有効にする場合は以下の作業を行ってください:
1."sqlite3.exe"を用意
  http://www.sqlite.org/download.html の「Precompiled Binaries for Windows」から
  "sqlite-shell-win32-x86-{数字}.zip"をダウンロードして、中身の"sqlite3.exe"を
  TVTest.exeのある場所かパスの通った場所(C:\windows あたりがオススメ)に配置
2.ブラウザでニコニコ実況にログイン
  FirefoxまたはGoogleChromeで http://jk.nicovideo.jp/ にアクセスして各自のアカウ
  ントでログイン
3.NicoJK.iniのexecGetCookieにブラウザのプロファイルフォルダを設定
  プロファイルフォルダの場所については「firefox cookies.sqlite」や「chrome
  cookie 保存場所」などのキーワードでググって見つけてください。正しく設定すれば
  プラグイン有効時にこのコマンドが実行され、勢い窓にコメント投稿欄が現れます

コメント投稿欄の仕様は以下のとおりです:
・Enterキー押下で投稿
・行頭に@があればローカルコマンドとして処理(詳しくは投稿欄に半角で"@help"と入力)
・行頭に[]で囲われた部分があれば公式サイトのコマンド欄と同等
・投稿欄が空のとき、Ctrl+Vで複数行のペーストができる
・TabまたはRS(レコードセパレータ)文字は改行文字と解釈する
  ・RSは右クリ→「Unicode制御文字の挿入」で入力可能。IMEに辞書登録すると便利
・最長75文字。最短投稿間隔は3秒

専用のアカウントを使う場合は、ログイン用のユーザプロファイルをブラウザに作成する
と便利です。Firefoxの手順:
1.-no-remote -p sub(←プロファイル名、何でもOK)というオプション付きでfirefox.exe
  へのショートカットを作成して起動
2.「ユーザプロファイルの選択」というウィンドウが出るので"sub"という名前の新しい
  プロファイルを作成
3.リストボックスは"default"プロファイルを選択して終了ボタンを押す。以降はショー
  トカットから起動したときに"sub"プロファイルが使われる

■制限
この改造版では、勢いリストの実況番号を選択したときに自動的にチャンネル変更する機
能は実装していません。チャンネル変更時には適当な実況番号に変更します。
今のところbigコマンドは解釈しません。

身も蓋もないですがサーバから過去ログをとってくるほうが明らかに筋がいいです。本体
リリースまでの繋ぎにでも…

■ソースコードについて
同じ役割の変数などはなるべく元の名前を使ってますが、元ソースと結構大きく変わって
しまっているのでdiffはとり辛いと思います(スミマセン…
おもにNicoJKへのパッチ提供が目的なので、もしもNicoJK本体にとりこまれた場合、その
部分はNicoJK本体のライセンスに従ってください。それ以外は自由に使ってください。
連投などサーバに迷惑をかけるような用途に利用するのは禁止です。

GDI+での描画と実況鯖接続について「イグトランスの頭の中（のかけら）-ニコニコ実況
からコメントを取得した」http://dev.activebasic.com/egtra/2010/03/03/210/ の記事
がとても参考になりました。
コメント投稿について「PITACore Box-コメントクライアント」
http://pita.s374.xrea.com/blog/archives/100 の記事が参考になりました。

■ログの仕様(開発者むけ)
ルートフォルダに"jk{実況番号}"というフォルダ(jkフォルダ)を作成する。jkフォルダに
は"{10桁のunix時間(=ログの最初のchatタグのdate属性値)}.txt"というログファイルを
作成する。ログファイル追記中は"lockfile"というファイルをjkフォルダに排他モードで
開いておく。ルートフォルダには(jkフォルダと被らなければ)任意のフォルダやファイル
を置くことができるが、jkフォルダにはログ以外の.txtファイルは置くべきでない。

ログファイルは実況サーバから取得したUTF-8のchatタグを改行CRLFで羅列したもの。
chatタグの要素に改行を含むときはLF=&#10;、CR=&#13;の数値文字参照に置きかえる。
chatタグの左右に空白その他の文字を加えてはいけない(BOMも特別扱いしないので先頭行
にはコメントなど入れておくと安全かも)。chat以外のタグを含んでも構わないが、最終
行はchatタグでなければならない(最終行のdate属性値からログの範囲を求めるため)。

■更新履歴
修正18(2013-10-29)
  TCPハーフクローズしないようにした
    一部ウィルス対策ソフトの環境で通信が中断されるため
  ついでに通信回りのコードをすこし整頓
修正17(2013-10-26)
  http://www1.axfc.net/u/3069154
  勢い窓にラジオのチャンネルを表示できるようにした(設定キーshowRadio)
  スレッド生成について微調整
修正16(2013-10-02)
  http://www1.axfc.net/uploader/so/3048093
  複数行コメントのフォントを指定できるようにした
  マージン大きめのフォントが下寄りにならないようにした
  ウィンドウが小さいときにテクスチャキャッシュを小さくしすぎないようにした
  Vista以降について、下コメの無駄な更新処理をさらに削減
  デバッグ表示機能を追加(ローカルコマンド@debug) ※個人都合のテキトーな機能
修正15(2013-09-04)
  http://www1.axfc.net/uploader/so/3018213
  ログファイルをシークするときの負荷を軽減
  非チューナー系BonDriver(UDPとか)で視聴中のチャンネル変更を検知できるようにした
  勢い窓を手前に表示中に音量変更などでメインウィンドウの後ろに隠れるのを防止
  NG登録ダイアログにコメ番も表示
  ログファイルをメインウィンドウにもD&Dできる機能を追加
  勢い窓の透過レベルを指定できるようにした(ローカルコマンド@fopa)
  コメント投稿欄が空のとき、Ctrl+Vで複数行のペーストができるようにした
修正14(2013-07-31)
  http://www1.axfc.net/uploader/so/2980886
  コメント投稿欄のプルダウンリストの装飾例をカスタマイズできるようにした
  メインスレッドの仕事を減らすためにコメント描画処理の大部分をスレッドに移した
  勢いリストの更新負荷をさらに軽減
  オフライン時はログフォルダにある実況チャンネルを勢い窓に表示するようにした
修正13(2013-05-29)
  http://www1.axfc.net/uploader/Sc/so/459765
  透過率スライドバーを追加
  Vista以降について、下コメの無駄な更新処理を削減
  勢い窓の位置復元処理を微修正
  timerIntervalのデフォルトを-5000に変更
  コメント投稿欄に"ローカルコマンド"機能を追加(実験的)
修正12(2013-05-20)
  http://www1.axfc.net/uploader/Sc/so/457294
  コメント投稿の上限はどうやら75文字のようなので緩和
  投稿文字数の上限を超えたときにログリストに警告を出すようにした
  コメント投稿欄でカーソルキー上下を押した時の挙動を修正
  RS文字も改行文字と解釈するようにした
  勢いリストの更新負荷を軽減
  ログファイルの先頭数秒分のコメントが表示されない場合があるのを修正
  4時リセット耐性をさらに向上
  3系統のコード(NicoJK_src/+OsdCompositor/+OsdCompositor+Texture)の平行更新が面
  倒になってきたので1系統に収束
修正11(2013-04-21)
  http://www1.axfc.net/uploader/Sc/so/448492
  暗色コメントは白い影をつけるようにした
  自分のコメント(yourpost="1")を目立つデザインで表示するようにした
  同じコメントの連続投稿をErrorにするようにした
  投稿後に空になったコメント入力欄をCtrl+Zで元に戻せるようにした
    投稿失敗した時にちょっとだけ便利
  ポストキー取得処理を微修正
修正10(2013-04-06)
  http://www1.axfc.net/uploader/Sc/so/444348
  コメント投稿機能を追加
  HTTP-GETリクエストを公式サイトにより近い形に調整(パケット解析の副産物)
修正9(2013-03-11)
  http://www1.axfc.net/uploader/Sc/so/435324
  コメントの表示期間を設定可能にした
  ue/shitaコメントを左右端に表示する属性(align="left|right")を追加
  ue/shitaコメントを時系列順に表示する属性(insert_at="last")を追加
  修正7を一部差し戻して4時リセット耐性を向上
  Vista以降について、閑散とした実況での無駄な更新処理を削減
修正8(2013-02-25)
  http://www1.axfc.net/uploader/Sc/so/431952
  スレ>>283報告起動時にパネル部分でも実況が流れてしまう問題を修正
  描画の同期ずれ(カクつき)を軽減
  大画面表示中にコメントの描画処理を半減できるようにした
  ini読み込みを高速化
修正7(2013-02-20)
  http://www1.axfc.net/uploader/Sc/so/428936
  スレ>>293報告Windows7でU+2588(FULL BLOCK)の上端が残る現象がみられたため対応
  commentLineMarginを100付近にしたときに下コメが1行だけ上に表示されるのを修正
  プラグイン有効時の表示ができるようにした
  smallコマンドに対応(文字サイズ75%で表示)
  Relチェックボックスのチェック状態を記憶するようにした
  4時リセット耐性を少し上げた
  chatタグに稀に'>'を含んだmail属性が来るっぽいので対応＋正規表現を最適化
修正6(2013-02-13)
  http://www1.axfc.net/uploader/Sc/so/426325
  フルスクリーン切替でコメントクリアしないようにした
  スレ>>248のマルチモニタ問題を解決できたかもしれない
  ログ再生ドライバ→非再生ドライバ変更後に指定ファイル再生できなくなるのを修正
  ユーザーNG機能をつけた(勢い窓のログリストをダブルクリック)
  コメントの置換機能をつけた
  軽量化のため非表示中のリストボックスの更新作業を省略
  安定性向上のためPCR/TOT取得部分をメッセージから排他制御に変更
修正5(2013-02-07)
  http://www1.axfc.net/uploader/Sc/so/424388
  指定ファイル再生機能をつけた(勢い窓のFile/Relチェックボックス)
  # 読み込めるファイルは下記ソフトの.jkl、.xml、およびNicoJKログの.txt
  # ・「JikkyoRec」http://d.hatena.ne.jp/modalblue/20130119/1358617042
  # ・「ニコニコ実況コメントビューア」http://air.fem.jp/jkcommentviewer/
  # ファイルに含まれる実況番号は無視します。Relチェックボックスはログの開始時刻
  # を現在の動画位置に合わせるかどうかです。ファイルを開くとPluginsフォルダに一
  # 時ファイル"NicoJK_{プロセスID}.tmp"が作成されます。
  commentFontOutlineキーに対応
  ログ記録に外部ツールのみ使う場合を考慮してlogfileModeキーの定義をすこし変更
  コメントシフト機能搭載
  バックバッファの初期化処理を軽量化
修正4(2013-02-02)
  http://www1.axfc.net/uploader/Sc/so/422213
  Vista以降でDWMのリフレッシュに同期して描画できるようにした
    デフォルトにはしないがなるべく設定することをお勧め(NicoJK.ini参照)
    # 先発の同種ソフトに同様の機能があったのでやり方をググってたらできた
    # http://d.hatena.ne.jp/c299792458/20100418 の記事が参考になりました
  複数行コメントのアライメントを間違えていたのを修正
    中央揃えだと勘違いしてた
修正3(2013-01-31)
  http://www1.axfc.net/uploader/Sc/so/421563
  ※本家の動きを待ちつつじわじわ追加パッチを上げる感じで行きます
  テクスチャキャッシュで負荷軽減
    古典的だけど結構効果があるよう(GDI実装が微妙なVista等でどうでるかは不明)
    ソースは"NicoJK_src.zip"→"+OsdCompositor.zip"→"+OsdCompositor+Texture.zip"
    の順に中身を上書き
  コメントは(公式には)75文字が最長らしいのでこれに合わせてバッファを少し削減
修正2(2013-01-26)
  http://www1.axfc.net/uploader/Sc/so/420106
  ※基本が揃った雰囲気なのでこの辺で改造版への機能追加を止めます(バグ修正はある
  かも)。機能追加するときはこれをベースにパッチする予定
  正規表現にミスがあったのを修正
    (?:^|&)ms=(\d+.\d+.\d+.\d+)(?:&|$) → (?:^|&)ms=(\d+\.\d+\.\d+\.\d+)(?:&|$)
    修正前のでも動作やセキュリティの問題はないだろうけど一応
  映像へのコメント合成機能をつけた
    非Aero環境でパフォーマンスが改善するかもしれない
    NicoJK+OsdCompositor_src.zipの中身をNicoJK_src.zipの中身に上書きする
    コードはTVCaptionMod2から引っ張ってきた(自由に利用してください)
修正1(2013-01-21)
  http://www1.axfc.net/uploader/Sc/so/418416
  コメント受信状態で勢い窓やコメントを表示切替できるようキー割り当てを2つ追加
  hideForceWindowキーを拡張
  複数行の実況コメントに対応
  初期受信時に実況コメントを1つだけ取りこぼす場合があるのを修正
  コメントが10秒間流れなければコメント描画用ウィンドウを隠すようにした
    動画に重ねているだけでもそれなりにCPU・GPUの負担になるため
  コンパイルオプション見直し
改造初版(2013-01-12)
  http://www1.axfc.net/uploader/Sc/so/415460
